\newpage
\begin{center}
	\textbf{\large 3. ПРОВЕРКА СТРАТЕГИЙ НА РЫНОЧНЫХ ДАННЫХ}
\end{center}
\refstepcounter{chapter}
\addcontentsline{toc}{chapter}{3. ПРОВЕРКА СТРАТЕГИЙ НА РЫНОЧНЫХ ДАННЫХ}

В этой главе оценивается доходность стратегий инвестирования, основанных на построении оптимального портфеля Марковица,
где для прогнозирования будущих ожидаемых значений используются алгоитмы машинного обучения и модели временных рядов.
\section{Подготовка данных}

Рыночные данные были выгружены с помощью API с криптовалютной биржи OKX \cite{okx}.
В качестве доступных для торговли активов рассматриваются 8 наиболее популярных крюптовалют.
Временной период с 1 января 2022 по  1 января 2025.
Был выбран дневной таймфрейм.
Период инвестирования 1 неделя.

На графике \ref{fig:prices} изображены динамики цен активов 

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{prices.png}
	\caption{Цены активов}
	\label{fig:prices}
\end{figure}

Перейдем от цен к недельным доходностям. Временные ряды соответсвующие доходностям 
представлены на графике \ref{fig:returns}, а некоторые статистики относительно распределений
доходностей в таблице \ref{tab:returns_describe}

\input{tables/returns_describe}

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{returns.png}
	\caption{Доходности активов}
	\label{fig:returns}
\end{figure}
Можно видеть редкие но достаточно сильные скачки.

Распределение доходностей активов представлено на гистограммах на рисунке \ref{fig:rois_hist}

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{rois_hist.png}
	\caption{Гистограммы доходностей активов}
	\label{fig:rois_hist}
\end{figure}

Из гистограмм видно, что распределение доходностей унимодально и имеет тяжелый правый хвост.

На графике \ref{fig:rois_mean_std} сравниваются активы с точки зрения 
среднего и стандартного отклонения доходности.

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{rois_mean_std.png}
	\caption{Среднее и стандартное отклонение доходностей}
	\label{fig:rois_mean_std}
\end{figure}

Разделим имеющиеся данные на валидационную и тестовую выборки. В качестве тестовых данных возьмем 2024 год.
По валидационной выборке подберем гиперпараметры для модели из каждого рассматриваемого класса.

В дальнейшем тестовые данные будут использоваться для:
\begin{enumerate}
	\item оценки качества прогнозирования средней ожидаемой доходности
	\item тестирования портфельных стратегий
\end{enumerate}

Из тестовых днных формируется набор тест-кейсов на которых и оценивается качество.
Процесс формирования тест-кейсов схематично проилюстрирован на рисунке \ref{fig:ts_csv}.
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{images/ts_cv}
	\caption{Формирование тест-кейсов из тестовых данных}
	\label{fig:ts_csv}
\end{figure}

Следующим этапом идет расчет необходимых параметров для оптимизации портфеля --- 
оценка ковариаций и прогноз средних значений доходности.

\section{Оценка ковариации между активами}

Особую сложность предстваляет задача прогноза будущей ковариации временных рядов. 
Вполне естественным вляется предположение стационарности ковариации во времени. 
Поэтому воспользуемся выборочной оценкой ковариации по историческим данным.

Имея $r_t$ - вектор-столбец доходностей в момент времени t, по истории наблюдений $r_1, \cdots r_n$ 
выборочная ковариация $\Sigma$ рассчитывается как 
\begin{align}
	\Sigma = \frac{1}{n} \sum_{t=1}^{n}(r_t - \overline{r}) \cdot (r_t - \overline{r})^T
\end{align}
где $\overline{r} = \frac{1}{n} \sum_{t=1}^{n} r_t$.

Корреляция Пирсона между доступными активами представлена на рисунке \ref{fig:corr}.

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{corr.png}
	\caption{Корреляции доходностей активов}
	\label{fig:corr}
\end{figure}

Активы имею сильную положительную корреляцию.

\section{Модели оценки средней доходности}

Задача оценки средней ожидаемой доходности сводиться к умению прогнозировать значение основываясь на стории наблюдений.
Для этого подходят классические статистические модели, модел имашинного обучения и нейросети в адаптации для прогнозирования 
временных рядов.

Ограничемся рассмотрением следующих моеделей:
\begin{enumerate}
	\item NAIVE - выборочное среднее
	\item MARTINGAL - прогноз последним наблюдаемым значением 
	\item ARIMA - модель авторегрессии и скользящего среднего
	\item LR - линейная регрессия
	\item RF - случайный лес
\end{enumerate}

Для каждого актива будем строить отдельную модель не принимающую в расчет историю других активов.
Таким образом, для прогноза будующих доходностей активов необходимо построить моделей по числу активов.

Некоторые модели (ARIMA, RF) --- допускают свободу в выборе гиперпараметров. 
Подбор гиперпараметров моделей осуществлялся по тренировочной выборке.

Качество прогнозирования моделей оценивается с помощью среднеквадратичной ошибки MSE (Mean Squared Error):
\begin{align}
	MSE = \frac{1}{n} \sum_{i=1}^{n} (r_i - \hat{r}_i)^2
\end{align}
где $r_i$ - истинное значение доходности,
а $\hat{r}_i$ - прогнозное значение модели на $i$-м объекте тестовой выборки.

Результаты оценки качества прогнозирования на тестовых данных представлены в таблице \ref{tab:ml_eval_metrics}

\input{tables/ml_eval_metrics}

Наихудшее значениие показывает подход NAIVE.
Это обусловлено резким ростом цен в 2024 году после относительно спокойной динамики.
MARTINGAL показывает хорошие результаты в случае рядов с затяжным трендов.
Остальные модели показывают сопоставимое качество.

\section{Проверка стратегий на тестовых данных}

Под стратегией будем понимать некоторый принцип или алгоритм по которому в каждый момент времени
формируется портфель.
Будем рассматривать стратегии двух видов:
\begin{itemize}
	\item тривиальные 
	\item основанные на идеи Марковица
\end{itemize}

Среди тривиальных стратегий выберем следующие:
\begin{enumerate}
	\item UNIFORM - равномерное инвестированиие во все доступные активы
	\item MOST RISKY - актив с наибольней дисперсией доходности
	\item LESS RISKY - актив с наименьшей дисперсией доходности
	\item BEST RETURN - актив с наибольшей средней доходностью
	\item WORST RETURN - актив с наименьшей средней доходностью
\end{enumerate}

Стратегии Марковица определяются риск-параметром и моделью оценки средней ожидаемой доходностью.
Риск-параметр будем воспринимать как параметризацию класса стратегий с определенной моделью оценки средней ожидаемой доходности.
Таким образом, одной стратегии Марковица соответсвует множество стратегий с разным риск-параметром. 
Это множество стратегий будет называть фронтирой.

На каждом тест-кейсе с помощью стратегии формируется инвестиционный портфель
в расчете на единичную сумму инвестирования и оценивается доходность ROI (Return On Investment) полученного портфеля.

На графике \ref{fig:result_frontier} представлены фронтиры соответсвующие торговым стратегиям.
Серым цветом отмечены тривиальные портфели.
По оси абсцисс отложены стандартые отклонения ROI, а по оси ординат --- средние значение ROI.

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{result_frontiers.png}
	\caption{Результаты тестирования стратегий}
	\label{fig:result_frontier}
\end{figure}

Более детально средние значения и стандартные отклонения ROI стратегий представлены в таблицах
\ref{tab:roi_mean} и \ref{tab:roi_std} соответственно.

Метрики тривиальных портфелей представлены в таблице \ref{tab:trivial_rois}

\input{tables/roi_mean}

\input{tables/roi_std}

\input{tables/trivial_rois}

